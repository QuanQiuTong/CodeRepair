### **基于开源大型语言模型的程序修复**

**答辩人：**
**日期：2025年7月14日**

---

#### **一、 项目概述 (约1分钟)**

**各位老师好！**

我本次报告的题目是“基于开源大型语言模型的程序修复”。

**1. 项目背景与目标：**
本项目基于现有的 `ChatRepair` 框架，其原始实现依赖于闭源的 ChatGPT API。我们的核心目标是将其改造为**使用本地化、开源的大型语言模型（如Qwen）**，以实现更低成本、更高私密性和更强可控性的自动化程序修复。

**2. 主要任务：**
*   **基础任务：** 替换模型核心，使用开源大模型修复 `QuixBugs` 数据集中的缺陷。
*   **进阶任务：** 验证并扩展该框架，使其能够成功修复更复杂、更真实的 `Defects4J` 数据集中的缺陷。

---

#### **二、 技术路线与实现 (约2分钟)**

我们的技术路线遵循 `ChatRepair` 的核心思想，即“**提示-生成-验证**”的闭环。

1.  **提示工程 (Prompting):**
    我们保留了 `ChatRepair` 的提示词构建方式，将包含bug的代码上下文、错误信息、触发测试用例等信息，构造成一个结构化的Prompt。

2.  **模型替换 (Model Replacement):**
    这是我们工作的核心。我们设计并实现了一个**可插拔的模型调用模块**。
    *   新建了 `util/qwen_request.py`，使用 `Hugging Face Transformers` 库封装了对本地 Qwen 模型的加载和推理逻辑。
    *   改造了原有的 `util/api_request.py`，增加了一个分发器（Dispatcher）。通过启动参数 `--engine`，程序可以灵活地在 `chatgpt` 和 `qwen` 之间切换，实现了对原有代码的**最小侵入式修改**。

3.  **验证与反馈 (Validation & Feedback):**
    我们利用 `Defects4J` 和 `QuixBugs` 自带的测试框架，对模型生成的补丁进行自动化验证。验证结果（如编译错误、测试失败）会作为反馈，加入到下一轮的提示中，引导模型进行多轮修复。

---

#### **三、 核心挑战与解决方案 (约5分钟)**

在将框架从理论迁移到实践的过程中，我们遇到了三大类核心挑战，这构成了我们项目的主要工作。

**挑战一：严重的环境与平台兼容性问题**

*   **问题描述：** `ChatRepair` 原始代码是为 Linux 环境设计的。在 Windows/WSL 环境下，我们遇到了大量问题，包括：
    1.  `rm`, `svn` 等 Linux 命令缺失。
    2.  Python 虚拟环境不兼容。
    3.  Windows 与 WSL 间的文件路径格式 (D: vs `/mnt/d/`) 冲突。
    4.  `Defects4J` 依赖的 Java 版本、环境变量配置复杂。
*   **解决方案：**
    1.  **果断迁移：** 放弃在 Windows 直接运行，将整个工作流迁移至 WSL。
    2.  **环境重建：** 在 WSL 中重新创建 Python 虚拟环境，并安装 `svn` 等缺失工具。
    3.  **路径修复：** 统一代码中的文件路径为 Linux 格式，解决了 `FileNotFoundError`。
    4.  **依赖攻坚：** 我们手动下载了 `Defects4J` 的所有依赖包，并编写了 `init2.sh` 脚本，通过检查文件是否存在来跳过耗时且不稳定的在线下载，最终成功在 WSL 中搭建了完整的 `Defects4J` 环境。

**挑战二：自动化测试中的“隐形杀手”**

*   **问题描述：** 在 `Defects4J` 的 `Chart` 项目中，即使模型生成了**完全正确**的补丁，验证流程依然失败或卡死。经过多轮调试，我们定位到两个隐蔽的原因：
    1.  **AWT/X11 错误：** `Chart` 的部分测试依赖图形界面，但在无界面的 WSL 环境中会因无法连接 X11 服务而**超时或直接报错**。
    2.  **区域设置 (Locale) 错误：** `testParseMonth` 测试用例依赖 `en_US` 区域设置来解析英文月份，但在中文 (`zh_CN`) 系统环境下会失败。
*   **解决方案：**
    1.  **釜底抽薪：** 我们没有采用“忽略错误”这种被动策略，而是找到了更根本的解决方案。
    2.  **强制无头和区域设置：** 通过设置 `_JAVA_OPTIONS` 环境变量，我们强制所有由 `Defects4J` 启动的 JVM 进程都以**无头模式 (Headless Mode)** 和 **`en_US` 区域设置**运行。这从根源上解决了所有与图形界面和区域设置相关的测试失败问题，是本次项目的一个**关键技术突破**。

**挑战三：代码生成与验证逻辑的冲突**

*   **问题描述：** 在修复流程中，频繁出现 `unreachable statement` 和 `illegal start of expression` 等编译错误，即使模型生成的逻辑是正确的。
*   **分析与解决：**
    1.  **定位原因：** 我们发现问题出在 `util.py` 的 `Writefile` 函数。它采用“填空”模式，将模型生成的单行代码插入模板。但当模型生成了完整的 `if` 代码块时，与模板中已有的 `}` 和 `return` 语句拼接后，就会产生语法错误。
    2.  **修复方案：** 我们调整了 `Writefile` 函数，确保在写入补丁时，只提取模型生成内容的第一行，避免了因代码结构冲突导致的编译失败。

---

#### **四、 成果与总结 (约2分钟)**

**1. 主要成果：**
*   成功将 `ChatRepair` 框架从依赖闭源 API 改造为**支持本地开源大模型**，并实现了模型间的灵活切换。
*   攻克了在 WSL 环境下部署和运行 `Defects4J` 的一系列**环境配置难题**。
*   深入分析并解决了 `Defects4J` 测试集中的**环境依赖问题**（如 X11 和 Locale），提出了通过 `_JAVA_OPTIONS` 环境变量进行全局配置的健壮方案。
*   成功使用改造后的框架，**修复了 `Defects4J` 中的多个真实缺陷**，例如 `Chart-1`, `Chart-10`, `Chart-11` 等，验证了整个技术路线的可行性。

**2. 总结与展望：**
本项目不仅成功完成了既定任务，更重要的是，在解决实际问题的过程中，我们积累了大量关于自动化程序修复框架、环境配置和跨平台兼容性的宝贵经验。

未来的工作可以从**提升修复效率**和**扩展模型能力**两个方向展开，例如：优化 Prompt 策略，或尝试集成更多不同架构的开源模型。

**我的报告到此结束，谢谢各位老师！**