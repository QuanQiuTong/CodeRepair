### **基于开源大型语言模型的程序修复：系统构建与模型能力探索**

**答辩人：**
**日期：2025年7月14日**

---

#### **一、 项目概述 (约1分钟)**

**各位老师好！**

我本次报告的题目是“基于开源大型语言模型的程序修复：系统构建与模型能力探索”。

**1. 项目目标：**
本项目旨在将 `ChatRepair` 框架从一个依赖闭源API的工具，**升级为一个支持本地化、开源大模型的、更具扩展性的自动化程序修复系统**。

**2. 核心任务：**
*   **系统改造：** 引入开源模型（Qwen）作为修复引擎，并对核心交互逻辑进行增强。
*   **能力验证：** 在 `QuixBugs` 和 `Defects4J` 这两个标准数据集上，验证并评估系统的修复能力。
*   **模型对比：** 对比分析开源模型（Qwen-4B）与先进闭源模型（GPT-4o-mini）在程序修复任务上的性能差异。

---

#### **二、 核心系统构建与创新 (约4分钟)**

为了达成目标，我们没有停留在简单替换API，而是对原有框架进行了三项关键的**建设性改进**。

**1. 创新一：可插拔、双语的修复引擎**

*   **工作内容：** 我们设计并实现了一个**可插拔的模型引擎**。通过简单的命令行参数 (`--engine`)，系统可以无缝切换 `Qwen` 和 `ChatGPT`。
*   **技术实现：**
    *   为适配Qwen，我们构建了独立的 `qwen_request.py` 模块，并编写了**针对性的中文Prompt**，以更好地激发其代码能力。
    *   在主流程中设立了分发逻辑，实现了对不同模型的统一调用，增强了系统的**灵活性和可扩展性**。

**2. 创新二：具备“记忆”的动态提示工程 (Dynamic Prompting with Memory)**

*   **问题背景：** 我们发现模型在多轮尝试中，会反复生成已经验证失败的错误补丁，极大地浪费了计算资源和调用次数。
*   **解决方案：** 我们实现了一个**具备“记忆”功能的动态Prompt生成器**。
    *   在每一次新的修复尝试前，系统会自动收集所有**历史失败补丁**。
    *   将这些失败记录作为“黑名单”追加到新的Prompt中，明确指示模型“**不要再次生成这些错误代码**”。
    *   同时，我们强化了对输出格式的要求，强制模型仅返回单行代码，避免了解析错误。
*   **效果：** 这一改进显著提升了修复的探索效率，避免了在无效的方案上重复试错。

**3. 创新三：健壮的自动化验证环境**

*   **问题背景：** `Defects4J` 作为一个十几年前的框架，其测试集在现代环境中存在大量“脆弱测试”（Brittle Tests），这些测试的失败与代码逻辑无关，而是由环境差异导致。
*   **系统加固：** 我们将解决这些问题视为**提升系统健大小异**的一部分。
    *   通过设置 `_JAVA_OPTIONS` 环境变量，我们强制所有测试在**无头模式 (Headless)** 和 **统一的`en_US`区域设置**下运行。
    *   这从根源上解决了因图形界面或系统语言不同导致的验证失败，确保了**验证结果的可靠性和一致性**。

---

#### **三、 实验结果与核心发现 (约3分钟)**

通过在 `Defects4J` 等数据集上进行大量实验，我们得出了几点核心发现：

**1. 自动化修复的必要性与可行性：**
*   实验证明，即使是强大的GPT-4o-mini，在面对复杂缺陷时也需要大量尝试。例如，修复 `Chart-12` 耗费了**184次**尝试。
*   这凸显了我们构建的**自动化、多轮试错、带记忆的修复循环**的巨大价值。没有这样的系统，手动修复将是不可想象的。

**2. 开源与闭源模型的显著差距：**
*   **准确性：** 在4B参数量级下，`Qwen3` 的修复成功率远低于 `GPT-4o-mini`。它更倾向于生成模板化、不完整的代码，或强制输出无用的思维链。
*   **效率与成本：**
    *   `GPT-4o-mini` 的API调用**速度极快**，单次成本仅约 **$0.0001**。
    *   本地部署 `Qwen3-4B` 则需要消耗近 **18.5GB 的显存**，单次推理耗时**1-2分钟**，时间与硬件成本高昂。

**3. 结论：**
对于程序修复这类需要高度逻辑推理和遵循复杂指令的任务，当前的小参数量开源模型（如4B）与顶尖的闭源模型之间仍存在**代差**。闭源模型在**效果、速度、综合成本**上拥有压倒性优势。

---

#### **四、 总结与展望 (约2分钟)**

**1. 项目总结：**
*   我们成功将 `ChatRepair` **从一个简单的脚本，升级为一个健壮、可扩展的自动化程序修复系统**。
*   核心贡献在于**创新的动态提示策略**和**对底层验证环境的深度加固**。
*   通过实证对比，我们量化了当前开源与闭源大模型在程序修复任务上的**能力差距**。

**2. 未来展望：**
*   **工程层面：** 可以进一步优化补丁的筛选和排序逻辑，优先尝试最有可能成功的补丁。
*   **研究层面：** 随着未来更强大的开源模型（如70B以上量级）的出现，可以基于本系统平台，快速进行新模型的评估和适配，探索开源模型在程序修复领域追赶的潜力。

**我的报告到此结束，谢谢各位老师！**